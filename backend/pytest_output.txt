============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-8.2.1, pluggy-1.6.0
rootdir: /app
configfile: pytest.ini
testpaths: tests
plugins: cov-5.0.0
collected 83 items

tests/test_activities_repo.py F..                                        [  3%]
tests/test_activities_service_unit.py ..                                 [  6%]
tests/test_api.py .F..FF........FFFFF.F.F.FFFF                           [ 39%]
tests/test_auth.py .....                                                 [ 45%]
tests/test_backup_manager.py .FF.                                        [ 50%]
tests/test_cache_namespace.py F                                          [ 51%]
tests/test_entries_repo.py FF.                                           [ 55%]
tests/test_export.py .FFF                                                [ 60%]
tests/test_health.py F..                                                 [ 63%]
tests/test_idempotent_writes.py FF                                       [ 66%]
tests/test_import_validation.py F.F                                      [ 69%]
tests/test_metrics.py FF                                                 [ 72%]
tests/test_stats_repo.py FF                                              [ 74%]
tests/test_stream_proxy.py ....                                          [ 79%]
tests/test_transactions.py F                                             [ 80%]
tests/test_users_repo.py F                                               [ 81%]
tests/test_validation.py .........                                       [ 92%]
tests/test_wearable_read.py ....                                         [ 97%]
tests/test_wearable_repo.py .                                            [ 98%]
tests/test_wearable_service_unit.py .                                    [100%]

=================================== FAILURES ===================================
______________________ test_insert_activity_and_overwrite ______________________

self = <sqlalchemy.engine.base.Connection object at 0x7a2c71862ae0>
dialect = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7a2c71af8a10>
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7a2c71717cb0>
statement = <sqlalchemy.dialects.postgresql.base.PGCompiler object at 0x7a2c71715760>
parameters = [{'p0': 'Reading', 'p1': 'Updated', 'p2': 'positive', 'p3': 1.0, ...}]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7a2c71af8a10>
cursor = <cursor object at 0x7a2c70307f10; closed: -1>
statement = '\n                INSERT INTO activities (\n                    name,\n                    category,\n               ...n                VALUES (%(p0)s, %(p1)s, %(p2)s, %(p3)s, %(p4)s, TRUE, %(p5)s, %(p6)s, NULL, %(p7)s)\n                '
parameters = {'p0': 'Reading', 'p1': 'Updated', 'p2': 'positive', 'p3': 1.0, ...}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7a2c71717cb0>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "activities_name_key"
E       DETAIL:  Key (name)=(Reading) already exists.

/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: UniqueViolation

The above exception was the direct cause of the following exception:

user_id = 1
payload = {'activity_type': 'positive', 'category': 'Updated', 'description': 'Books', 'frequency_per_day': 1, ...}
overwrite_existing = True

    def insert_activity(
        user_id: int, payload: Dict[str, Any], overwrite_existing: bool = False
    ) -> Tuple[Dict[str, Any], int]:
        """Insert a new activity, optionally overwriting an existing one."""
        name = payload["name"]
        params = (
            name,
            payload["category"],
            payload["activity_type"],
            payload["goal"],
            payload["description"],
            payload["frequency_per_day"],
            payload["frequency_per_week"],
            user_id,
        )
    
        with transactional_connection(db.engine) as conn:
            try:
>               conn.execute(
                    """
                    INSERT INTO activities (
                        name,
                        category,
                        activity_type,
                        goal,
                        description,
                        active,
                        frequency_per_day,
                        frequency_per_week,
                        deactivated_at,
                        user_id
                    )
                    VALUES (?, ?, ?, ?, ?, TRUE, ?, ?, NULL, ?)
                    """,
                    params,
                )

repositories/activities_repo.py:161: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
db_utils.py:102: in execute
    result = self._connection.execute(text(statement), bound_params)
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7a2c71af8a10>
cursor = <cursor object at 0x7a2c70307f10; closed: -1>
statement = '\n                INSERT INTO activities (\n                    name,\n                    category,\n               ...n                VALUES (%(p0)s, %(p1)s, %(p2)s, %(p3)s, %(p4)s, TRUE, %(p5)s, %(p6)s, NULL, %(p7)s)\n                '
parameters = {'p0': 'Reading', 'p1': 'Updated', 'p2': 'positive', 'p3': 1.0, ...}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7a2c71717cb0>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.IntegrityError: (psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "activities_name_key"
E       DETAIL:  Key (name)=(Reading) already exists.
E       
E       [SQL: 
E                       INSERT INTO activities (
E                           name,
E                           category,
E                           activity_type,
E                           goal,
E                           description,
E                           active,
E                           frequency_per_day,
E                           frequency_per_week,
E                           deactivated_at,
E                           user_id
E                       )
E                       VALUES (%(p0)s, %(p1)s, %(p2)s, %(p3)s, %(p4)s, TRUE, %(p5)s, %(p6)s, NULL, %(p7)s)
E                       ]
E       [parameters: {'p0': 'Reading', 'p1': 'Updated', 'p2': 'positive', 'p3': 1.0, 'p4': 'Books', 'p5': 1, 'p6': 7, 'p7': 1}]
E       (Background on this error at: https://sqlalche.me/e/20/gkpj)

/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: IntegrityError

During handling of the above exception, another exception occurred:

self = <sqlalchemy.engine.base.Connection object at 0x7a2c71862ae0>
dialect = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7a2c71af8a10>
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7a2c71710890>
statement = <sqlalchemy.dialects.postgresql.base.PGCompiler object at 0x7a2c71710710>
parameters = [{'p0': 'Updated', 'p1': 'positive', 'p2': 1.0, 'p3': 'Books', ...}]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7a2c71af8a10>
cursor = <cursor object at 0x7a2c70370040; closed: -1>
statement = '\n                UPDATE activities\n                SET\n                    category = %(p0)s,\n                   ...        active = TRUE\n                WHERE name = %(p6)s AND (user_id = %(p7)s OR user_id IS NULL)\n                '
parameters = {'p0': 'Updated', 'p1': 'positive', 'p2': 1.0, 'p3': 'Books', ...}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7a2c71710890>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       psycopg2.errors.InFailedSqlTransaction: current transaction is aborted, commands ignored until end of transaction block

/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: InFailedSqlTransaction

The above exception was the direct cause of the following exception:

    @pytest.mark.usefixtures("client")
    def test_insert_activity_and_overwrite():
        with app.app_context():
            user = _create_user("insert_user")
            payload = {
                "name": "Reading",
                "category": "Leisure",
                "activity_type": "positive",
                "goal": 1.0,
                "description": "Books",
                "frequency_per_day": 1,
                "frequency_per_week": 7,
            }
            response, status = activities_repo.insert_activity(user.id, payload)
            assert status == 201
            assert response["message"]
    
            row = db.session.execute(
                select(Activity).where(Activity.name == "Reading", Activity.user_id == user.id)
            ).scalar_one()
            assert row.category == "Leisure"
    
            with pytest.raises(activities_repo.ConflictError):
                activities_repo.insert_activity(user.id, payload, overwrite_existing=False)
    
            payload["category"] = "Updated"
>           response, status = activities_repo.insert_activity(
                user.id, payload, overwrite_existing=True
            )

tests/test_activities_repo.py:44: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
repositories/activities_repo.py:183: in insert_activity
    conn.execute(
db_utils.py:102: in execute
    result = self._connection.execute(text(statement), bound_params)
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7a2c71af8a10>
cursor = <cursor object at 0x7a2c70370040; closed: -1>
statement = '\n                UPDATE activities\n                SET\n                    category = %(p0)s,\n                   ...        active = TRUE\n                WHERE name = %(p6)s AND (user_id = %(p7)s OR user_id IS NULL)\n                '
parameters = {'p0': 'Updated', 'p1': 'positive', 'p2': 1.0, 'p3': 'Books', ...}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7a2c71710890>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.InternalError: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E       
E       [SQL: 
E                       UPDATE activities
E                       SET
E                           category = %(p0)s,
E                           activity_type = %(p1)s,
E                           goal = %(p2)s,
E                           description = %(p3)s,
E                           frequency_per_day = %(p4)s,
E                           frequency_per_week = %(p5)s,
E                           deactivated_at = NULL,
E                           active = TRUE
E                       WHERE name = %(p6)s AND (user_id = %(p7)s OR user_id IS NULL)
E                       ]
E       [parameters: {'p0': 'Updated', 'p1': 'positive', 'p2': 1.0, 'p3': 'Books', 'p4': 1, 'p5': 7, 'p6': 'Reading', 'p7': 1}]
E       (Background on this error at: https://sqlalche.me/e/20/2j85)

/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: InternalError
_________________________ test_add_activity_and_toggle _________________________

client = <FlaskClient <MosaicFlask 'app'>>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ1c2VyXzdkN2MyYmQ4IiwiY3N...idXNlcl83ZDdjMmJkOCJ9.IgPsW-owrakqg2rN_qXHjXrYVppB7j3XmL1EBWugAgY', 'X-CSRF-Token': '57c5c90897cf0e9db7ee1d751a01d1a0'}

>   ???
E   AssertionError: assert [{'active': 1...': None, ...}] == []
E     
E     Left contains one more item: {'active': 1, 'activity_type': 'positive', 'category': 'Leisure', 'deactivated_at': None, ...}
E     Use -v to get more diff

/home/jan/Dokumenty/code/mosaic/backend/tests/test_api.py:62: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_7d7c2bd8"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:09.069762Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 193.51, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:09.074692Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_7d7c2bd8", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:09.256487Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 215.89, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:09.291770Z"}
------------------------------ Captured log setup ------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_7d7c2bd8"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:09.069762Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 193.51, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:09.074692Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_7d7c2bd8", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:09.256487Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 215.89, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:09.291770Z"}
----------------------------- Captured stdout call -----------------------------
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Reading", "category": "Leisure"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:09.301249Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 20.32, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:09.317176Z"}
{"method": "GET", "path": "/activities", "status_code": 200, "duration_ms": 2.13, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:09.321176Z"}
{"method": "PATCH", "path": "/activities/1/deactivate", "status_code": 200, "duration_ms": 2.92, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:09.325974Z"}
{"method": "GET", "path": "/activities", "status_code": 200, "duration_ms": 1.69, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:09.330853Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Reading", "category": "Leisure"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:09.301249Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 20.32, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:09.317176Z"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/activities", "status_code": 200, "duration_ms": 2.13, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:09.321176Z"}
INFO     mosaic.backend:app.py:304 {"method": "PATCH", "path": "/activities/1/deactivate", "status_code": 200, "duration_ms": 2.92, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:09.325974Z"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/activities", "status_code": 200, "duration_ms": 1.69, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:09.330853Z"}
____________________________ test_add_entry_upsert _____________________________

client = <FlaskClient <MosaicFlask 'app'>>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ1c2VyXzliM2NiNjU0IiwiY3N...idXNlcl85YjNjYjY1NCJ9.XA40yRgztplBTdcI8mwawTWZdL0UCrFjItpla_oXNc8', 'X-CSRF-Token': 'f31ff9192890eb73d7bb70a9d6f79abf'}

>   ???
E   assert 201 == 200
E    +  where 201 = <WrapperTestResponse streamed [201 CREATED]>.status_code

/home/jan/Dokumenty/code/mosaic/backend/tests/test_api.py:133: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_9b3cb654"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:10.825666Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 136.25, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:10.867265Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_9b3cb654", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:10.965845Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 124.71, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:10.993065Z"}
------------------------------ Captured log setup ------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_9b3cb654"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:10.825666Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 136.25, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:10.867265Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_9b3cb654", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:10.965845Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 124.71, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:10.993065Z"}
----------------------------- Captured stdout call -----------------------------
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Exercise", "category": "Health"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:10.995990Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 11.76, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:11.005996Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 10.46, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:11.017319Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 2.74, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:11.021081Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Exercise", "category": "Health"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:10.995990Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 11.76, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:11.005996Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 10.46, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:11.017319Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 2.74, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:11.021081Z"}
_________________________ test_today_and_finalize_day __________________________

client = <FlaskClient <MosaicFlask 'app'>>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ1c2VyX2UxOTdhZGJlIiwiY3N...idXNlcl9lMTk3YWRiZSJ9.YBqqiI6MPaJr2loRGyq0NXw0RYmoAznjR-loApduv8Y', 'X-CSRF-Token': '0001c0f4192800ab9c0da7423c7cbb68'}

>   ???
E   AssertionError: assert 1 == 2
E    +  where 1 = len({'error': {'code': 'internal_error', 'details': {}, 'message': 'An unexpected error occurred'}})

/home/jan/Dokumenty/code/mosaic/backend/tests/test_api.py:172: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_e197adbe"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:11.353135Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 127.38, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:11.382715Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_e197adbe", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:11.504291Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 148.66, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:11.532107Z"}
------------------------------ Captured log setup ------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_e197adbe"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:11.353135Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 127.38, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:11.382715Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_e197adbe", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:11.504291Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 148.66, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:11.532107Z"}
----------------------------- Captured stdout call -----------------------------
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Coding", "category": "Work"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:11.535489Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 11.21, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:11.544829Z"}
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Workout", "category": "Health"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:11.546877Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 3.14, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:11.548853Z"}
{"status_code": 500, "error": "'tuple' object has no attribute 'user_id'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:11.550019Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/entries_controller.py\", line 131, in get_today\n    data = stats_service.get_today_payload(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/stats_service.py\", line 29, in get_today_payload\n    cached = cache_get(\"today\", cache_key_parts, scope=cache_scope)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 41, in cache_get\n    key = build_cache_key(prefix, key_parts, scope=scope)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 35, in build_cache_key\n    namespaced_parts = _cache_scope_key_parts(scope) + key_parts\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 26, in _cache_scope_key_parts\n    f\"user:{scope.user_id}\" if scope.user_id is not None else \"user:anonymous\"\n                               ^^^^^^^^^^^^^\nAttributeError: 'tuple' object has no attribute 'user_id'"}
{"method": "GET", "path": "/today", "status_code": 500, "duration_ms": 3.42, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:11.553397Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Coding", "category": "Work"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:11.535489Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 11.21, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:11.544829Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Workout", "category": "Health"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:11.546877Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 3.14, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:11.548853Z"}
ERROR    mosaic.backend:app.py:355 {"status_code": 500, "error": "'tuple' object has no attribute 'user_id'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:11.550019Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/entries_controller.py\", line 131, in get_today\n    data = stats_service.get_today_payload(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/stats_service.py\", line 29, in get_today_payload\n    cached = cache_get(\"today\", cache_key_parts, scope=cache_scope)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 41, in cache_get\n    key = build_cache_key(prefix, key_parts, scope=scope)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 35, in build_cache_key\n    namespaced_parts = _cache_scope_key_parts(scope) + key_parts\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 26, in _cache_scope_key_parts\n    f\"user:{scope.user_id}\" if scope.user_id is not None else \"user:anonymous\"\n                               ^^^^^^^^^^^^^\nAttributeError: 'tuple' object has no attribute 'user_id'"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/today", "status_code": 500, "duration_ms": 3.42, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:11.553397Z"}
_______________________ test_update_activity_propagates ________________________

client = <FlaskClient <MosaicFlask 'app'>>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ1c2VyXzBhZTk4YzFmIiwiY3N...idXNlcl8wYWU5OGMxZiJ9.wlqNX9dEHxodWaDazJkPwqXsocNa8oAgdbBOwQzPZc8', 'X-CSRF-Token': 'b786954a41fbfc75e76abfdeffbcaa10'}

>   ???
E   AssertionError: assert 'Mind' == 'Wellness'
E     
E     - Wellness
E     + Mind

/home/jan/Dokumenty/code/mosaic/backend/tests/test_api.py:368: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_0ae98c1f"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:15.473095Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 105.23, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:15.480241Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_0ae98c1f", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:15.612669Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 135.42, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:15.616440Z"}
------------------------------ Captured log setup ------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_0ae98c1f"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:15.473095Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 105.23, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:15.480241Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_0ae98c1f", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:15.612669Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 135.42, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:15.616440Z"}
----------------------------- Captured stdout call -----------------------------
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Meditation", "category": "Mind"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:15.621070Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 4.79, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:15.623285Z"}
{"method": "GET", "path": "/activities", "status_code": 200, "duration_ms": 1.66, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:15.626378Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 4.73, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:15.632601Z"}
{"method": "PUT", "path": "/activities/1", "status_code": 200, "duration_ms": 3.26, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:15.637391Z"}
{"method": "GET", "path": "/activities", "status_code": 200, "duration_ms": 1.16, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:15.640075Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Meditation", "category": "Mind"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:15.621070Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 4.79, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:15.623285Z"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/activities", "status_code": 200, "duration_ms": 1.66, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:15.626378Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 4.73, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:15.632601Z"}
INFO     mosaic.backend:app.py:304 {"method": "PUT", "path": "/activities/1", "status_code": 200, "duration_ms": 3.26, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:15.637391Z"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/activities", "status_code": 200, "duration_ms": 1.16, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:15.640075Z"}
____________________ test_today_respects_deactivation_date _____________________

client = <FlaskClient <MosaicFlask 'app'>>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ1c2VyXzExNTFkMTI5IiwiY3N...idXNlcl8xMTUxZDEyOSJ9.HPBQnPCvenGCwyUhPtOlJ7-y7t0y0ks6WasT4-tFtqc', 'X-CSRF-Token': '7a908c627360fe10a4a5a0287a2d869a'}

>   ???

/home/jan/Dokumenty/code/mosaic/backend/tests/test_api.py:398: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

.0 = <dict_keyiterator object at 0x7a2c7023d710>

>   ???
E   TypeError: string indices must be integers, not 'str'

/home/jan/Dokumenty/code/mosaic/backend/tests/test_api.py:398: TypeError
---------------------------- Captured stdout setup -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_1151d129"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:16.012877Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 105.71, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.020599Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_1151d129", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:16.151601Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 138.34, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.159648Z"}
------------------------------ Captured log setup ------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_1151d129"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:16.012877Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 105.71, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.020599Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_1151d129", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:16.151601Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 138.34, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.159648Z"}
----------------------------- Captured stdout call -----------------------------
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Journal", "category": "Reflection"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:16.162613Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 10.74, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.171600Z"}
{"method": "GET", "path": "/activities", "status_code": 200, "duration_ms": 1.29, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.173718Z"}
{"status_code": 500, "error": "'tuple' object has no attribute 'user_id'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:16.174606Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/entries_controller.py\", line 131, in get_today\n    data = stats_service.get_today_payload(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/stats_service.py\", line 29, in get_today_payload\n    cached = cache_get(\"today\", cache_key_parts, scope=cache_scope)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 41, in cache_get\n    key = build_cache_key(prefix, key_parts, scope=scope)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 35, in build_cache_key\n    namespaced_parts = _cache_scope_key_parts(scope) + key_parts\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 26, in _cache_scope_key_parts\n    f\"user:{scope.user_id}\" if scope.user_id is not None else \"user:anonymous\"\n                               ^^^^^^^^^^^^^\nAttributeError: 'tuple' object has no attribute 'user_id'"}
{"method": "GET", "path": "/today", "status_code": 500, "duration_ms": 1.15, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.175706Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Journal", "category": "Reflection"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:16.162613Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 10.74, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.171600Z"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/activities", "status_code": 200, "duration_ms": 1.29, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.173718Z"}
ERROR    mosaic.backend:app.py:355 {"status_code": 500, "error": "'tuple' object has no attribute 'user_id'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:16.174606Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/entries_controller.py\", line 131, in get_today\n    data = stats_service.get_today_payload(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/stats_service.py\", line 29, in get_today_payload\n    cached = cache_get(\"today\", cache_key_parts, scope=cache_scope)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 41, in cache_get\n    key = build_cache_key(prefix, key_parts, scope=scope)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 35, in build_cache_key\n    namespaced_parts = _cache_scope_key_parts(scope) + key_parts\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 26, in _cache_scope_key_parts\n    f\"user:{scope.user_id}\" if scope.user_id is not None else \"user:anonymous\"\n                               ^^^^^^^^^^^^^\nAttributeError: 'tuple' object has no attribute 'user_id'"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/today", "status_code": 500, "duration_ms": 1.15, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.175706Z"}
________________ test_entry_metadata_survives_activity_deletion ________________

client = <FlaskClient <MosaicFlask 'app'>>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ1c2VyXzc1Zjc3YjFkIiwiY3N...idXNlcl83NWY3N2IxZCJ9.ESfg8-GmvfH38-323TsV_A9IhflVLdABTTc-Q8SoT4E', 'X-CSRF-Token': 'f34331e0989188feb4451785956f8a48'}

>   ???
E   StopIteration

/home/jan/Dokumenty/code/mosaic/backend/tests/test_api.py:431: StopIteration
---------------------------- Captured stdout setup -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_75f77b1d"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:16.498819Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 101.66, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.506656Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_75f77b1d", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:16.613046Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 113.99, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.621375Z"}
------------------------------ Captured log setup ------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_75f77b1d"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:16.498819Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 101.66, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.506656Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_75f77b1d", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:16.613046Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 113.99, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.621375Z"}
----------------------------- Captured stdout call -----------------------------
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Swim", "category": "Fitness"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:16.624132Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 10.7, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.633294Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.6, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.637757Z"}
{"method": "GET", "path": "/activities", "status_code": 200, "duration_ms": 1.05, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.639877Z"}
{"method": "PATCH", "path": "/activities/1/deactivate", "status_code": 200, "duration_ms": 1.46, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.642145Z"}
{"method": "DELETE", "path": "/activities/1", "status_code": 400, "duration_ms": 1.23, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.644572Z"}
{"method": "GET", "path": "/entries", "status_code": 200, "duration_ms": 1.1, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.646815Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Swim", "category": "Fitness"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:16.624132Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 10.7, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.633294Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.6, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.637757Z"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/activities", "status_code": 200, "duration_ms": 1.05, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.639877Z"}
INFO     mosaic.backend:app.py:304 {"method": "PATCH", "path": "/activities/1/deactivate", "status_code": 200, "duration_ms": 1.46, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.642145Z"}
INFO     mosaic.backend:app.py:304 {"method": "DELETE", "path": "/activities/1", "status_code": 400, "duration_ms": 1.23, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.644572Z"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/entries", "status_code": 200, "duration_ms": 1.1, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.646815Z"}
____________________________ test_entries_filtering ____________________________

client = <FlaskClient <MosaicFlask 'app'>>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ1c2VyX2M2ZWQzNDZkIiwiY3N...idXNlcl9jNmVkMzQ2ZCJ9._RyTFRHb8PWnLX1RApnb1K7CjHCf0mtLSUPEr7gyQdA', 'X-CSRF-Token': 'c551292b10a82f0eff18017841bd452e'}

>   ???
E   assert 0 == 1
E    +  where 0 = len([])

/home/jan/Dokumenty/code/mosaic/backend/tests/test_api.py:483: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_c6ed346d"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:16.960880Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 101.14, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.969087Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_c6ed346d", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:17.068897Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 107.94, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.077734Z"}
------------------------------ Captured log setup ------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_c6ed346d"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:16.960880Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 101.14, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:16.969087Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_c6ed346d", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:17.068897Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 107.94, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.077734Z"}
----------------------------- Captured stdout call -----------------------------
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Read", "category": "Leisure"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:17.080537Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 11.99, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.090882Z"}
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Jog", "category": "Health"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:17.093720Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 5.06, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.097224Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 14.77, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.113378Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 6.05, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.120922Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 6.91, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.129551Z"}
{"method": "GET", "path": "/entries", "status_code": 200, "duration_ms": 5.14, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.136873Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Read", "category": "Leisure"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:17.080537Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 11.99, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.090882Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Jog", "category": "Health"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:17.093720Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 5.06, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.097224Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 14.77, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.113378Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 6.05, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.120922Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 6.91, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.129551Z"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/entries", "status_code": 200, "duration_ms": 5.14, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.136873Z"}
____________________ test_stats_progress_payload_structure _____________________

client = <FlaskClient <MosaicFlask 'app'>>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ1c2VyX2FlZDU1NmJmIiwiY3N...idXNlcl9hZWQ1NTZiZiJ9.mI72YDUU1eoqynCEsusxGWSLDl6XWNaCU3tGK2vll7k', 'X-CSRF-Token': 'bf0313c90262aaab0525ed5b9c7d07ca'}

>   ???
E   assert 500 == 200
E    +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

/home/jan/Dokumenty/code/mosaic/backend/tests/test_api.py:543: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_aed556bf"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:17.485474Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 102.79, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.494315Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_aed556bf", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:17.620126Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 135.37, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.630430Z"}
------------------------------ Captured log setup ------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_aed556bf"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:17.485474Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 102.79, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.494315Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_aed556bf", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:17.620126Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 135.37, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.630430Z"}
----------------------------- Captured stdout call -----------------------------
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Walking", "category": "Health"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:17.637539Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 11.67, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.644309Z"}
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Reading", "category": "Art"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:17.648133Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 4.75, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.651214Z"}
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Coding", "category": "Work"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:17.654964Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 3.8, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.657108Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 5.08, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.663572Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.79, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.668741Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.53, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.673842Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.27, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.678458Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.34, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.683196Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.17, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.687669Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 2.99, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.691942Z"}
{"status_code": 500, "error": "'tuple' object has no attribute 'user_id'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:17.693060Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/stats_controller.py\", line 19, in get_progress_stats\n    payload = stats_service.get_progress_stats(\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/stats_service.py\", line 66, in get_progress_stats\n    cached = cache_get(\"stats\", cache_key_parts, scope=cache_scope)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 41, in cache_get\n    key = build_cache_key(prefix, key_parts, scope=scope)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 35, in build_cache_key\n    namespaced_parts = _cache_scope_key_parts(scope) + key_parts\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 26, in _cache_scope_key_parts\n    f\"user:{scope.user_id}\" if scope.user_id is not None else \"user:anonymous\"\n                               ^^^^^^^^^^^^^\nAttributeError: 'tuple' object has no attribute 'user_id'"}
{"method": "GET", "path": "/stats/progress", "status_code": 500, "duration_ms": 1.22, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.694216Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Walking", "category": "Health"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:17.637539Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 11.67, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.644309Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Reading", "category": "Art"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:17.648133Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 4.75, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.651214Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Coding", "category": "Work"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:17.654964Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 3.8, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.657108Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 5.08, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.663572Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.79, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.668741Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.53, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.673842Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.27, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.678458Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.34, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.683196Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.17, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.687669Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 2.99, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.691942Z"}
ERROR    mosaic.backend:app.py:355 {"status_code": 500, "error": "'tuple' object has no attribute 'user_id'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:17.693060Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/stats_controller.py\", line 19, in get_progress_stats\n    payload = stats_service.get_progress_stats(\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/stats_service.py\", line 66, in get_progress_stats\n    cached = cache_get(\"stats\", cache_key_parts, scope=cache_scope)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 41, in cache_get\n    key = build_cache_key(prefix, key_parts, scope=scope)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 35, in build_cache_key\n    namespaced_parts = _cache_scope_key_parts(scope) + key_parts\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 26, in _cache_scope_key_parts\n    f\"user:{scope.user_id}\" if scope.user_id is not None else \"user:anonymous\"\n                               ^^^^^^^^^^^^^\nAttributeError: 'tuple' object has no attribute 'user_id'"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/stats/progress", "status_code": 500, "duration_ms": 1.22, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:17.694216Z"}
___________________________ test_entries_pagination ____________________________

client = <FlaskClient <MosaicFlask 'app'>>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ1c2VyXzU3YTkzZTZkIiwiY3N...idXNlcl81N2E5M2U2ZCJ9.ZN--C27V98aMho-fTUb3msvgxrw6gYphu5prvSKcBGQ', 'X-CSRF-Token': '428cb0dbc1dda4cd8f222c792c30873f'}

>   ???
E   assert 0 == 2
E    +  where 0 = len([])
E    +    where [] = <bound method Response.get_json of <WrapperTestResponse 3 bytes [200 OK]>>()
E    +      where <bound method Response.get_json of <WrapperTestResponse 3 bytes [200 OK]>> = <WrapperTestResponse 3 bytes [200 OK]>.get_json

/home/jan/Dokumenty/code/mosaic/backend/tests/test_api.py:670: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_57a93e6d"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:18.539217Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 150.84, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:18.550020Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_57a93e6d", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:18.654286Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 112.84, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:18.663587Z"}
------------------------------ Captured log setup ------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_57a93e6d"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:18.539217Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 150.84, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:18.550020Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_57a93e6d", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:18.654286Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 112.84, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:18.663587Z"}
----------------------------- Captured stdout call -----------------------------
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Task", "category": "Testing"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:18.666376Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 11.61, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:18.676346Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.65, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:18.680842Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 2.88, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:18.684821Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.02, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:18.688949Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 2.84, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:18.692882Z"}
{"method": "GET", "path": "/entries", "status_code": 200, "duration_ms": 1.31, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:18.695257Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Task", "category": "Testing"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:18.666376Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 11.61, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:18.676346Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.65, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:18.680842Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 2.88, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:18.684821Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.02, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:18.688949Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 2.84, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:18.692882Z"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/entries", "status_code": 200, "duration_ms": 1.31, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:18.695257Z"}
____________________________ test_today_pagination _____________________________

client = <FlaskClient <MosaicFlask 'app'>>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ1c2VyXzg4NmM2MzBjIiwiY3N...idXNlcl84ODZjNjMwYyJ9.lnuZEkxe0K7RFN3wtAKYPiu142iRuAv0Tbv8vomKx24', 'X-CSRF-Token': 'b6fe493d2f49d29562d03204e1f0615f'}

>   ???
E   assert 500 == 200
E    +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

/home/jan/Dokumenty/code/mosaic/backend/tests/test_api.py:715: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_886c630c"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:19.696183Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 118.37, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:19.708801Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_886c630c", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:19.835582Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 136.24, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:19.846205Z"}
------------------------------ Captured log setup ------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_886c630c"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:19.696183Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 118.37, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:19.708801Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_886c630c", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:19.835582Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 136.24, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:19.846205Z"}
----------------------------- Captured stdout call -----------------------------
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Todo 0", "category": "Daily"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:19.848916Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 12.49, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:19.859877Z"}
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Todo 1", "category": "Daily"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:19.861906Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 3.1, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:19.863803Z"}
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Todo 2", "category": "Daily"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:19.866313Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 4.37, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:19.869279Z"}
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Todo 3", "category": "Daily"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:19.871264Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 2.8, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:19.872928Z"}
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Todo 4", "category": "Daily"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:19.875270Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 4.02, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:19.878062Z"}
{"status_code": 500, "error": "'tuple' object has no attribute 'user_id'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:19.878967Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/entries_controller.py\", line 131, in get_today\n    data = stats_service.get_today_payload(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/stats_service.py\", line 29, in get_today_payload\n    cached = cache_get(\"today\", cache_key_parts, scope=cache_scope)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 41, in cache_get\n    key = build_cache_key(prefix, key_parts, scope=scope)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 35, in build_cache_key\n    namespaced_parts = _cache_scope_key_parts(scope) + key_parts\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 26, in _cache_scope_key_parts\n    f\"user:{scope.user_id}\" if scope.user_id is not None else \"user:anonymous\"\n                               ^^^^^^^^^^^^^\nAttributeError: 'tuple' object has no attribute 'user_id'"}
{"method": "GET", "path": "/today", "status_code": 500, "duration_ms": 1.31, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:19.880213Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Todo 0", "category": "Daily"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:19.848916Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 12.49, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:19.859877Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Todo 1", "category": "Daily"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:19.861906Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 3.1, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:19.863803Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Todo 2", "category": "Daily"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:19.866313Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 4.37, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:19.869279Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Todo 3", "category": "Daily"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:19.871264Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 2.8, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:19.872928Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Todo 4", "category": "Daily"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:19.875270Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 4.02, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:19.878062Z"}
ERROR    mosaic.backend:app.py:355 {"status_code": 500, "error": "'tuple' object has no attribute 'user_id'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:19.878967Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/entries_controller.py\", line 131, in get_today\n    data = stats_service.get_today_payload(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/stats_service.py\", line 29, in get_today_payload\n    cached = cache_get(\"today\", cache_key_parts, scope=cache_scope)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 41, in cache_get\n    key = build_cache_key(prefix, key_parts, scope=scope)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 35, in build_cache_key\n    namespaced_parts = _cache_scope_key_parts(scope) + key_parts\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 26, in _cache_scope_key_parts\n    f\"user:{scope.user_id}\" if scope.user_id is not None else \"user:anonymous\"\n                               ^^^^^^^^^^^^^\nAttributeError: 'tuple' object has no attribute 'user_id'"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/today", "status_code": 500, "duration_ms": 1.31, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:19.880213Z"}
________________________ test_today_cache_invalidation _________________________

client = <FlaskClient <MosaicFlask 'app'>>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ1c2VyX2ZkNjBkZmYyIiwiY3N...idXNlcl9mZDYwZGZmMiJ9.pkt9Q0CSJn0egSa--azkf7Ug4g5ZJYnRRpe-GgfvG5Q', 'X-CSRF-Token': '0a70f44c5291f4ff7db17e2906caa43c'}

>   ???
E   assert 500 == 200
E    +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

/home/jan/Dokumenty/code/mosaic/backend/tests/test_api.py:728: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_fd60dff2"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:20.717032Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 106.26, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:20.728975Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_fd60dff2", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:20.846866Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 131.14, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:20.860865Z"}
------------------------------ Captured log setup ------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_fd60dff2"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:20.717032Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 106.26, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:20.728975Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_fd60dff2", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:20.846866Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 131.14, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:20.860865Z"}
----------------------------- Captured stdout call -----------------------------
{"status_code": 500, "error": "'tuple' object has no attribute 'user_id'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:20.863435Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/entries_controller.py\", line 131, in get_today\n    data = stats_service.get_today_payload(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/stats_service.py\", line 29, in get_today_payload\n    cached = cache_get(\"today\", cache_key_parts, scope=cache_scope)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 41, in cache_get\n    key = build_cache_key(prefix, key_parts, scope=scope)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 35, in build_cache_key\n    namespaced_parts = _cache_scope_key_parts(scope) + key_parts\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 26, in _cache_scope_key_parts\n    f\"user:{scope.user_id}\" if scope.user_id is not None else \"user:anonymous\"\n                               ^^^^^^^^^^^^^\nAttributeError: 'tuple' object has no attribute 'user_id'"}
{"method": "GET", "path": "/today", "status_code": 500, "duration_ms": 3.71, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:20.866946Z"}
------------------------------ Captured log call -------------------------------
ERROR    mosaic.backend:app.py:355 {"status_code": 500, "error": "'tuple' object has no attribute 'user_id'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:20.863435Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/entries_controller.py\", line 131, in get_today\n    data = stats_service.get_today_payload(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/stats_service.py\", line 29, in get_today_payload\n    cached = cache_get(\"today\", cache_key_parts, scope=cache_scope)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 41, in cache_get\n    key = build_cache_key(prefix, key_parts, scope=scope)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 35, in build_cache_key\n    namespaced_parts = _cache_scope_key_parts(scope) + key_parts\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 26, in _cache_scope_key_parts\n    f\"user:{scope.user_id}\" if scope.user_id is not None else \"user:anonymous\"\n                               ^^^^^^^^^^^^^\nAttributeError: 'tuple' object has no attribute 'user_id'"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/today", "status_code": 500, "duration_ms": 3.71, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:20.866946Z"}
________________________ test_stats_cache_invalidation _________________________

client = <FlaskClient <MosaicFlask 'app'>>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ1c2VyXzk4N2Y3ZDljIiwiY3N...idXNlcl85ODdmN2Q5YyJ9.MCleR9pQcN-qghqSmKFtq9fzy-CRroAOVSXyPh6lL8o', 'X-CSRF-Token': '11b7e88d76621c0b9213898e4d539f3e'}

>   ???
E   assert 500 == 200
E    +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

/home/jan/Dokumenty/code/mosaic/backend/tests/test_api.py:771: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_987f7d9c"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:21.208395Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 106.97, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.221040Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_987f7d9c", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:21.333405Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 126.0, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.348020Z"}
------------------------------ Captured log setup ------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_987f7d9c"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:21.208395Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 106.97, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.221040Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_987f7d9c", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:21.333405Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 126.0, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.348020Z"}
----------------------------- Captured stdout call -----------------------------
{"method": "GET", "path": "/user", "status_code": 200, "duration_ms": 1.55, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.351738Z"}
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "CacheStat", "category": "Cache"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:21.357279Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 8.12, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.361598Z"}
{"status_code": 500, "error": "'tuple' object has no attribute 'user_id'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:21.363115Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/stats_controller.py\", line 19, in get_progress_stats\n    payload = stats_service.get_progress_stats(\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/stats_service.py\", line 66, in get_progress_stats\n    cached = cache_get(\"stats\", cache_key_parts, scope=cache_scope)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 41, in cache_get\n    key = build_cache_key(prefix, key_parts, scope=scope)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 35, in build_cache_key\n    namespaced_parts = _cache_scope_key_parts(scope) + key_parts\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 26, in _cache_scope_key_parts\n    f\"user:{scope.user_id}\" if scope.user_id is not None else \"user:anonymous\"\n                               ^^^^^^^^^^^^^\nAttributeError: 'tuple' object has no attribute 'user_id'"}
{"method": "GET", "path": "/stats/progress", "status_code": 500, "duration_ms": 2.87, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.365881Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/user", "status_code": 200, "duration_ms": 1.55, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.351738Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "CacheStat", "category": "Cache"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:21.357279Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 8.12, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.361598Z"}
ERROR    mosaic.backend:app.py:355 {"status_code": 500, "error": "'tuple' object has no attribute 'user_id'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:21.363115Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/stats_controller.py\", line 19, in get_progress_stats\n    payload = stats_service.get_progress_stats(\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/stats_service.py\", line 66, in get_progress_stats\n    cached = cache_get(\"stats\", cache_key_parts, scope=cache_scope)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 41, in cache_get\n    key = build_cache_key(prefix, key_parts, scope=scope)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 35, in build_cache_key\n    namespaced_parts = _cache_scope_key_parts(scope) + key_parts\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 26, in _cache_scope_key_parts\n    f\"user:{scope.user_id}\" if scope.user_id is not None else \"user:anonymous\"\n                               ^^^^^^^^^^^^^\nAttributeError: 'tuple' object has no attribute 'user_id'"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/stats/progress", "status_code": 500, "duration_ms": 2.87, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.365881Z"}
___________________ test_negative_activity_entries_and_today ___________________

client = <FlaskClient <MosaicFlask 'app'>>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ1c2VyXzdhOTkzMjFlIiwiY3N...idXNlcl83YTk5MzIxZSJ9.yjxiq2kQAknKGt1cGAVncvlGEM_aC1oy6857SlrFEjQ', 'X-CSRF-Token': '30fff6e1f54e8495816e1048a89a0663'}

>   ???
E   assert []

/home/jan/Dokumenty/code/mosaic/backend/tests/test_api.py:846: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_7a99321e"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:21.729576Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 114.25, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.742364Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_7a99321e", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:21.855687Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 127.77, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.870891Z"}
------------------------------ Captured log setup ------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_7a99321e"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:21.729576Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 114.25, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.742364Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_7a99321e", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:21.855687Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 127.77, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.870891Z"}
----------------------------- Captured stdout call -----------------------------
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Mindful Break", "category": "Calm"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:21.876306Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 10.04, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.884133Z"}
{"method": "GET", "path": "/activities", "status_code": 200, "duration_ms": 1.96, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.889674Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 5.15, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.896816Z"}
{"method": "GET", "path": "/entries", "status_code": 200, "duration_ms": 1.62, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.899884Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Mindful Break", "category": "Calm"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:21.876306Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 10.04, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.884133Z"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/activities", "status_code": 200, "duration_ms": 1.96, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.889674Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 5.15, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.896816Z"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/entries", "status_code": 200, "duration_ms": 1.62, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:21.899884Z"}
___________________ test_negative_activity_ignored_in_stats ____________________

client = <FlaskClient <MosaicFlask 'app'>>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ1c2VyXzVlMjU1NTM4IiwiY3N...idXNlcl81ZTI1NTUzOCJ9.jkHqEp6jlW2Bi2uKiBqmGsF3lowdBAhe5XN_sN3zWmQ', 'X-CSRF-Token': 'fb7406993dd5156ba23c8e4b2da39971'}

>   ???
E   assert 500 == 200
E    +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

/home/jan/Dokumenty/code/mosaic/backend/tests/test_api.py:887: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_5e255538"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:22.251739Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 111.99, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:22.265030Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_5e255538", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:22.381588Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 129.27, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:22.395042Z"}
------------------------------ Captured log setup ------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_5e255538"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:22.251739Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 111.99, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:22.265030Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_5e255538", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:22.381588Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 129.27, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:22.395042Z"}
----------------------------- Captured stdout call -----------------------------
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Skip Sugar", "category": "Health"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:22.398882Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 13.13, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:22.409981Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 5.16, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:22.417713Z"}
{"status_code": 500, "error": "'tuple' object has no attribute 'user_id'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:22.419426Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/stats_controller.py\", line 19, in get_progress_stats\n    payload = stats_service.get_progress_stats(\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/stats_service.py\", line 66, in get_progress_stats\n    cached = cache_get(\"stats\", cache_key_parts, scope=cache_scope)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 41, in cache_get\n    key = build_cache_key(prefix, key_parts, scope=scope)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 35, in build_cache_key\n    namespaced_parts = _cache_scope_key_parts(scope) + key_parts\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 26, in _cache_scope_key_parts\n    f\"user:{scope.user_id}\" if scope.user_id is not None else \"user:anonymous\"\n                               ^^^^^^^^^^^^^\nAttributeError: 'tuple' object has no attribute 'user_id'"}
{"method": "GET", "path": "/stats/progress", "status_code": 500, "duration_ms": 1.89, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:22.421220Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Skip Sugar", "category": "Health"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:22.398882Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 13.13, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:22.409981Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 5.16, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:22.417713Z"}
ERROR    mosaic.backend:app.py:355 {"status_code": 500, "error": "'tuple' object has no attribute 'user_id'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:22.419426Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/stats_controller.py\", line 19, in get_progress_stats\n    payload = stats_service.get_progress_stats(\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/stats_service.py\", line 66, in get_progress_stats\n    cached = cache_get(\"stats\", cache_key_parts, scope=cache_scope)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 41, in cache_get\n    key = build_cache_key(prefix, key_parts, scope=scope)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 35, in build_cache_key\n    namespaced_parts = _cache_scope_key_parts(scope) + key_parts\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 26, in _cache_scope_key_parts\n    f\"user:{scope.user_id}\" if scope.user_id is not None else \"user:anonymous\"\n                               ^^^^^^^^^^^^^\nAttributeError: 'tuple' object has no attribute 'user_id'"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/stats/progress", "status_code": 500, "duration_ms": 1.89, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:22.421220Z"}
________________________ test_backup_run_creates_files _________________________

client = <FlaskClient <MosaicFlask 'app'>>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ1c2VyX2UzNTRhMzE1IiwiY3N...idXNlcl9lMzU0YTMxNSJ9.1mHHUHNX4T8duFog3n24_veYIWfOic01D11EP9YFHGc', 'X-CSRF-Token': '2d05d67bca71daff98bd9ab538dd602f'}
backup_env = <backup_manager.BackupManager object at 0x7a2c718fa870>
tmp_path = PosixPath('/tmp/pytest-of-root/pytest-0/test_backup_run_creates_files0')

>   ???
E   assert None is not None

/home/jan/Dokumenty/code/mosaic/backend/tests/test_backup_manager.py:75: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_e354a315"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:25.574841Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 193.86, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:25.581875Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_e354a315", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:25.740473Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 176.95, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:25.760076Z"}
------------------------------ Captured log setup ------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_e354a315"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:25.574841Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 193.86, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:25.581875Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_e354a315", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:25.740473Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 176.95, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:25.760076Z"}
----------------------------- Captured stdout call -----------------------------
{"event_type": "backup.run", "user_id": 1, "message": "Backup created", "context": {"backup": {"timestamp": "20251118-183325", "json": "backup-20251118-183325.json", "csv": "backup-20251118-183325.csv", "zip": "backup-20251118-183325.zip", "generated_at": "2025-11-18T18:33:25.766744+00:00"}}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:25.797735Z"}
{"method": "POST", "path": "/backup/run", "status_code": 200, "duration_ms": 41.1, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:25.808029Z"}
{"method": "GET", "path": "/backup/status", "status_code": 200, "duration_ms": 2.11, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:25.816935Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "backup.run", "user_id": 1, "message": "Backup created", "context": {"backup": {"timestamp": "20251118-183325", "json": "backup-20251118-183325.json", "csv": "backup-20251118-183325.csv", "zip": "backup-20251118-183325.zip", "generated_at": "2025-11-18T18:33:25.766744+00:00"}}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:25.797735Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/backup/run", "status_code": 200, "duration_ms": 41.1, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:25.808029Z"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/backup/status", "status_code": 200, "duration_ms": 2.11, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:25.816935Z"}
________________________ test_backup_toggle_persistence ________________________

client = <FlaskClient <MosaicFlask 'app'>>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ1c2VyX2Q3MGJjMzEwIiwiY3N...idXNlcl9kNzBiYzMxMCJ9.3R_zXpsj7BKWNUqilZGDgeqkK6Pn8FDhN8KvOiaeqDs', 'X-CSRF-Token': '6df160707797818d395e6c23f52bd5d6'}
backup_env = <backup_manager.BackupManager object at 0x7a2c703aa780>

>   ???
E   assert False is True

/home/jan/Dokumenty/code/mosaic/backend/tests/test_backup_manager.py:87: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_d70bc310"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:26.192498Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 133.61, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:26.220033Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_d70bc310", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:26.345653Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 140.91, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:26.362095Z"}
------------------------------ Captured log setup ------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_d70bc310"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:26.192498Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 133.61, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:26.220033Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_d70bc310", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:26.345653Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 140.91, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:26.362095Z"}
----------------------------- Captured stdout call -----------------------------
{"event_type": "backup.toggle", "user_id": 1, "message": "Backup settings updated", "context": {"status": {"enabled": false, "interval_minutes": 60, "last_run": null, "backups": "[]"}}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:26.392137Z"}
{"method": "POST", "path": "/backup/toggle", "status_code": 200, "duration_ms": 28.96, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:26.395185Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "backup.toggle", "user_id": 1, "message": "Backup settings updated", "context": {"status": {"enabled": false, "interval_minutes": 60, "last_run": null, "backups": "[]"}}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:26.392137Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/backup/toggle", "status_code": 200, "duration_ms": 28.96, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:26.395185Z"}
__________________ test_cache_entries_are_namespaced_per_user __________________

client = <FlaskClient <MosaicFlask 'app'>>

>   ???
E   assert 500 == 200
E    +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

/home/jan/Dokumenty/code/mosaic/backend/tests/test_cache_namespace.py:51: AssertionError
----------------------------- Captured stdout call -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_e1e99902"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:27.395399Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 134.87, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:27.413181Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_e1e99902", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:27.510634Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 113.73, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:27.528113Z"}
{"event_type": "auth.register", "user_id": 2, "message": "User registered", "context": {"username": "user_ee94cfef"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:27.649316Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 137.75, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:27.666675Z"}
{"event_type": "auth.login", "user_id": 2, "message": "User logged in", "context": {"username": "user_ee94cfef", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:27.824513Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 178.08, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:27.845910Z"}
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Namespaced Activity", "category": "Cache"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:27.848703Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 10.79, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:27.858111Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 5.23, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:27.866428Z"}
{"status_code": 500, "error": "'tuple' object has no attribute 'user_id'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:27.867500Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/entries_controller.py\", line 131, in get_today\n    data = stats_service.get_today_payload(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/stats_service.py\", line 29, in get_today_payload\n    cached = cache_get(\"today\", cache_key_parts, scope=cache_scope)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 41, in cache_get\n    key = build_cache_key(prefix, key_parts, scope=scope)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 35, in build_cache_key\n    namespaced_parts = _cache_scope_key_parts(scope) + key_parts\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 26, in _cache_scope_key_parts\n    f\"user:{scope.user_id}\" if scope.user_id is not None else \"user:anonymous\"\n                               ^^^^^^^^^^^^^\nAttributeError: 'tuple' object has no attribute 'user_id'"}
{"method": "GET", "path": "/today", "status_code": 500, "duration_ms": 3.71, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:27.871165Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_e1e99902"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:27.395399Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 134.87, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:27.413181Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_e1e99902", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:27.510634Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 113.73, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:27.528113Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 2, "message": "User registered", "context": {"username": "user_ee94cfef"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:27.649316Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 137.75, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:27.666675Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 2, "message": "User logged in", "context": {"username": "user_ee94cfef", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:27.824513Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 178.08, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:27.845910Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Namespaced Activity", "category": "Cache"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:27.848703Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 10.79, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:27.858111Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 5.23, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:27.866428Z"}
ERROR    mosaic.backend:app.py:355 {"status_code": 500, "error": "'tuple' object has no attribute 'user_id'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:27.867500Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/entries_controller.py\", line 131, in get_today\n    data = stats_service.get_today_payload(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/stats_service.py\", line 29, in get_today_payload\n    cached = cache_get(\"today\", cache_key_parts, scope=cache_scope)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 41, in cache_get\n    key = build_cache_key(prefix, key_parts, scope=scope)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 35, in build_cache_key\n    namespaced_parts = _cache_scope_key_parts(scope) + key_parts\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 26, in _cache_scope_key_parts\n    f\"user:{scope.user_id}\" if scope.user_id is not None else \"user:anonymous\"\n                               ^^^^^^^^^^^^^\nAttributeError: 'tuple' object has no attribute 'user_id'"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/today", "status_code": 500, "duration_ms": 3.71, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:27.871165Z"}
____________________ test_upsert_creates_and_updates_entry _____________________

    @pytest.mark.usefixtures("client")
    def test_upsert_creates_and_updates_entry():
        with app.app_context():
            user = _create_user("repo_create")
            payload, status = entries_repo.upsert_entry_with_metadata_check(
                user.id, "2024-01-01", "Exercise", 3.0, "note"
            )
            assert status == 201
            assert payload["message"]
    
            row = db.session.execute(
                select(Entry).where(Entry.user_id == user.id, Entry.activity == "Exercise")
            ).scalar_one()
            assert row.value == pytest.approx(3.0)
            assert row.note == "note"
    
            payload, status = entries_repo.upsert_entry_with_metadata_check(
                user.id, "2024-01-01", "Exercise", 4.0, "updated"
            )
            assert status == 200
            assert payload["message"]
    
            updated = db.session.execute(
                select(Entry).where(Entry.user_id == user.id, Entry.activity == "Exercise")
            ).scalar_one()
>           assert updated.value == pytest.approx(4.0)
E           assert 3.0 == 4.0  4.0e-06
E             
E             comparison failed
E             Obtained: 3.0
E             Expected: 4.0  4.0e-06

tests/test_entries_repo.py:43: AssertionError
_______________________ test_upsert_adopts_shared_entry ________________________

    @pytest.mark.usefixtures("client")
    def test_upsert_adopts_shared_entry():
        with app.app_context():
            user = _create_user("repo_adopt")
            shared_entry = Entry(
                date="2024-02-01",
                activity="Read",
                description="existing",
                value=1.0,
                note="shared",
                activity_category="Leisure",
                activity_goal=1.0,
                activity_type="positive",
                user_id=None,
            )
            db.session.add(shared_entry)
            db.session.commit()
    
            payload, status = entries_repo.upsert_entry_with_metadata_check(
                user.id, "2024-02-01", "Read", 2.0, "claimed"
            )
            assert status == 200
            assert payload["message"]
    
            adopted = db.session.execute(
                select(Entry).where(Entry.activity == "Read", Entry.date == "2024-02-01")
            ).scalar_one()
>           assert adopted.user_id == user.id
E           assert None == 1
E            +  where None = <Entry 2024-02-01 Read>.user_id
E            +  and   1 = <User repo_adopt>.id

tests/test_entries_repo.py:74: AssertionError
_______________ test_export_json_includes_entries_and_activities _______________

client = <FlaskClient <MosaicFlask 'app'>>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ1c2VyXzM5MTExMTViIiwiY3N...idXNlcl8zOTExMTE1YiJ9.h1lWEqjQ0Le7bpoLq2Dusjy5YbcdIVaGMTgFmmnrQI8', 'X-CSRF-Token': '509f1e9651a858736ebde3a0dc52746e'}

>   ???
E   assert 500 == 200
E    +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

/home/jan/Dokumenty/code/mosaic/backend/tests/test_export.py:73: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_3911115b"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:29.751609Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 227.34, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:29.777073Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_3911115b", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:29.959361Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 200.89, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:29.981454Z"}
------------------------------ Captured log setup ------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_3911115b"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:29.751609Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 227.34, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:29.777073Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_3911115b", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:29.959361Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 200.89, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:29.981454Z"}
----------------------------- Captured stdout call -----------------------------
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Reading", "category": "Leisure"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:29.987140Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 12.01, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:29.994980Z"}
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Running", "category": "Health"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:29.998266Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 5.55, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.001857Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 12.55, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.016654Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 9.79, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.029249Z"}
{"status_code": 500, "error": "Could not locate column in row for column '0'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:30.037451Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/security.py\", line 83, in wrapped\n    return fn(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/backup_controller.py\", line 79, in export_json\n    payload, meta = backup_service.build_export_payload(\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/backup_service.py\", line 130, in build_export_payload\n    entries, activities, total_entries, total_activities = fetch_export_data(\n                                                           ^^^^^^^^^^^^^^^^^^\n  File \"/app/services/backup_service.py\", line 117, in fetch_export_data\n    total_entries = backup_repo.count_export_entries(user_id, is_admin)\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/repositories/backup_repo.py\", line 114, in count_export_entries\n    return int(row[0]) if row else 0\n               ~~~^^^\n  File \"lib/sqlalchemy/cyextension/resultproxy.pyx\", line 57, in sqlalchemy.cyextension.resultproxy.BaseRow._get_by_key_impl_mapping\n  File \"lib/sqlalchemy/cyextension/resultproxy.pyx\", line 63, in sqlalchemy.cyextension.resultproxy.BaseRow._get_by_key_impl\n  File \"/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/result.py\", line 203, in _key_not_found\n    self._key_fallback(key, None)\n  File \"/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/cursor.py\", line 825, in _key_fallback\n    raise exc.NoSuchColumnError(\nsqlalchemy.exc.NoSuchColumnError: Could not locate column in row for column '0'"}
{"method": "GET", "path": "/export/json", "status_code": 500, "duration_ms": 12.99, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.044702Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Reading", "category": "Leisure"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:29.987140Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 12.01, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:29.994980Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Running", "category": "Health"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:29.998266Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 5.55, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.001857Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 12.55, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.016654Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 9.79, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.029249Z"}
ERROR    mosaic.backend:app.py:355 {"status_code": 500, "error": "Could not locate column in row for column '0'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:30.037451Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/security.py\", line 83, in wrapped\n    return fn(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/backup_controller.py\", line 79, in export_json\n    payload, meta = backup_service.build_export_payload(\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/backup_service.py\", line 130, in build_export_payload\n    entries, activities, total_entries, total_activities = fetch_export_data(\n                                                           ^^^^^^^^^^^^^^^^^^\n  File \"/app/services/backup_service.py\", line 117, in fetch_export_data\n    total_entries = backup_repo.count_export_entries(user_id, is_admin)\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/repositories/backup_repo.py\", line 114, in count_export_entries\n    return int(row[0]) if row else 0\n               ~~~^^^\n  File \"lib/sqlalchemy/cyextension/resultproxy.pyx\", line 57, in sqlalchemy.cyextension.resultproxy.BaseRow._get_by_key_impl_mapping\n  File \"lib/sqlalchemy/cyextension/resultproxy.pyx\", line 63, in sqlalchemy.cyextension.resultproxy.BaseRow._get_by_key_impl\n  File \"/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/result.py\", line 203, in _key_not_found\n    self._key_fallback(key, None)\n  File \"/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/cursor.py\", line 825, in _key_fallback\n    raise exc.NoSuchColumnError(\nsqlalchemy.exc.NoSuchColumnError: Could not locate column in row for column '0'"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/export/json", "status_code": 500, "duration_ms": 12.99, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.044702Z"}
________________________ test_export_pagination_offset _________________________

client = <FlaskClient <MosaicFlask 'app'>>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ1c2VyXzk0OTZmNDNhIiwiY3N...idXNlcl85NDk2ZjQzYSJ9.j-ZWXj1xhymjL20SKkg2B-GTDQX-wGngf7IjOD6quZM', 'X-CSRF-Token': 'e8aaae2ab815720809b9f3afbb05172d'}

>   ???
E   assert 500 == 200
E    +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

/home/jan/Dokumenty/code/mosaic/backend/tests/test_export.py:94: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_9496f43a"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:30.528279Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 160.38, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.548309Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_9496f43a", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:30.645269Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 116.01, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.665137Z"}
------------------------------ Captured log setup ------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_9496f43a"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:30.528279Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 160.38, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.548309Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_9496f43a", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:30.645269Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 116.01, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.665137Z"}
----------------------------- Captured stdout call -----------------------------
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Reading", "category": "Leisure"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:30.668181Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 11.3, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.677641Z"}
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Running", "category": "Health"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:30.680634Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 4.99, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.684202Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 7.52, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.696642Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.27, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.701118Z"}
{"status_code": 500, "error": "Could not locate column in row for column '0'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:30.705387Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/security.py\", line 83, in wrapped\n    return fn(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/backup_controller.py\", line 79, in export_json\n    payload, meta = backup_service.build_export_payload(\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/backup_service.py\", line 130, in build_export_payload\n    entries, activities, total_entries, total_activities = fetch_export_data(\n                                                           ^^^^^^^^^^^^^^^^^^\n  File \"/app/services/backup_service.py\", line 117, in fetch_export_data\n    total_entries = backup_repo.count_export_entries(user_id, is_admin)\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/repositories/backup_repo.py\", line 114, in count_export_entries\n    return int(row[0]) if row else 0\n               ~~~^^^\n  File \"lib/sqlalchemy/cyextension/resultproxy.pyx\", line 57, in sqlalchemy.cyextension.resultproxy.BaseRow._get_by_key_impl_mapping\n  File \"lib/sqlalchemy/cyextension/resultproxy.pyx\", line 63, in sqlalchemy.cyextension.resultproxy.BaseRow._get_by_key_impl\n  File \"/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/result.py\", line 203, in _key_not_found\n    self._key_fallback(key, None)\n  File \"/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/cursor.py\", line 825, in _key_fallback\n    raise exc.NoSuchColumnError(\nsqlalchemy.exc.NoSuchColumnError: Could not locate column in row for column '0'"}
{"method": "GET", "path": "/export/json", "status_code": 500, "duration_ms": 4.09, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.706745Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Reading", "category": "Leisure"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:30.668181Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 11.3, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.677641Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Running", "category": "Health"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:30.680634Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 4.99, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.684202Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 7.52, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.696642Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.27, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.701118Z"}
ERROR    mosaic.backend:app.py:355 {"status_code": 500, "error": "Could not locate column in row for column '0'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:30.705387Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/security.py\", line 83, in wrapped\n    return fn(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/backup_controller.py\", line 79, in export_json\n    payload, meta = backup_service.build_export_payload(\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/backup_service.py\", line 130, in build_export_payload\n    entries, activities, total_entries, total_activities = fetch_export_data(\n                                                           ^^^^^^^^^^^^^^^^^^\n  File \"/app/services/backup_service.py\", line 117, in fetch_export_data\n    total_entries = backup_repo.count_export_entries(user_id, is_admin)\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/repositories/backup_repo.py\", line 114, in count_export_entries\n    return int(row[0]) if row else 0\n               ~~~^^^\n  File \"lib/sqlalchemy/cyextension/resultproxy.pyx\", line 57, in sqlalchemy.cyextension.resultproxy.BaseRow._get_by_key_impl_mapping\n  File \"lib/sqlalchemy/cyextension/resultproxy.pyx\", line 63, in sqlalchemy.cyextension.resultproxy.BaseRow._get_by_key_impl\n  File \"/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/result.py\", line 203, in _key_not_found\n    self._key_fallback(key, None)\n  File \"/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/cursor.py\", line 825, in _key_fallback\n    raise exc.NoSuchColumnError(\nsqlalchemy.exc.NoSuchColumnError: Could not locate column in row for column '0'"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/export/json", "status_code": 500, "duration_ms": 4.09, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:30.706745Z"}
____________________________ test_export_csv_format ____________________________

client = <FlaskClient <MosaicFlask 'app'>>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJ1c2VyXzkwZDI2ZmI5IiwiY3N...idXNlcl85MGQyNmZiOSJ9.qdOnK0QCw3hHtGdaa2XzM99_7CbyH8g7wpXTJ9YN1BY', 'X-CSRF-Token': '7be7b458ef93c5430ab4ce412e692e71'}

>   ???
E   assert 500 == 200
E    +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

/home/jan/Dokumenty/code/mosaic/backend/tests/test_export.py:105: AssertionError
---------------------------- Captured stdout setup -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_90d26fb9"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:31.060772Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 137.75, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:31.094804Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_90d26fb9", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:31.226053Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 147.13, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:31.242805Z"}
------------------------------ Captured log setup ------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "user_90d26fb9"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:31.060772Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 137.75, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:31.094804Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "user_90d26fb9", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:31.226053Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 147.13, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:31.242805Z"}
----------------------------- Captured stdout call -----------------------------
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Reading", "category": "Leisure"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:31.245712Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 4.35, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:31.248320Z"}
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Running", "category": "Health"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:31.250343Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 2.87, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:31.251985Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.59, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:31.256383Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 2.55, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:31.259935Z"}
{"status_code": 500, "error": "Could not locate column in row for column '0'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:31.263456Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/security.py\", line 83, in wrapped\n    return fn(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/backup_controller.py\", line 114, in export_csv\n    payload, meta = backup_service.build_export_payload(\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/backup_service.py\", line 130, in build_export_payload\n    entries, activities, total_entries, total_activities = fetch_export_data(\n                                                           ^^^^^^^^^^^^^^^^^^\n  File \"/app/services/backup_service.py\", line 117, in fetch_export_data\n    total_entries = backup_repo.count_export_entries(user_id, is_admin)\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/repositories/backup_repo.py\", line 114, in count_export_entries\n    return int(row[0]) if row else 0\n               ~~~^^^\n  File \"lib/sqlalchemy/cyextension/resultproxy.pyx\", line 57, in sqlalchemy.cyextension.resultproxy.BaseRow._get_by_key_impl_mapping\n  File \"lib/sqlalchemy/cyextension/resultproxy.pyx\", line 63, in sqlalchemy.cyextension.resultproxy.BaseRow._get_by_key_impl\n  File \"/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/result.py\", line 203, in _key_not_found\n    self._key_fallback(key, None)\n  File \"/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/cursor.py\", line 825, in _key_fallback\n    raise exc.NoSuchColumnError(\nsqlalchemy.exc.NoSuchColumnError: Could not locate column in row for column '0'"}
{"method": "GET", "path": "/export/csv", "status_code": 500, "duration_ms": 3.43, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:31.264326Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Reading", "category": "Leisure"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:31.245712Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 4.35, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:31.248320Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Running", "category": "Health"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:31.250343Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 2.87, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:31.251985Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 3.59, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:31.256383Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 2.55, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:31.259935Z"}
ERROR    mosaic.backend:app.py:355 {"status_code": 500, "error": "Could not locate column in row for column '0'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:31.263456Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/security.py\", line 83, in wrapped\n    return fn(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/backup_controller.py\", line 114, in export_csv\n    payload, meta = backup_service.build_export_payload(\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/backup_service.py\", line 130, in build_export_payload\n    entries, activities, total_entries, total_activities = fetch_export_data(\n                                                           ^^^^^^^^^^^^^^^^^^\n  File \"/app/services/backup_service.py\", line 117, in fetch_export_data\n    total_entries = backup_repo.count_export_entries(user_id, is_admin)\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/repositories/backup_repo.py\", line 114, in count_export_entries\n    return int(row[0]) if row else 0\n               ~~~^^^\n  File \"lib/sqlalchemy/cyextension/resultproxy.pyx\", line 57, in sqlalchemy.cyextension.resultproxy.BaseRow._get_by_key_impl_mapping\n  File \"lib/sqlalchemy/cyextension/resultproxy.pyx\", line 63, in sqlalchemy.cyextension.resultproxy.BaseRow._get_by_key_impl\n  File \"/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/result.py\", line 203, in _key_not_found\n    self._key_fallback(key, None)\n  File \"/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/cursor.py\", line 825, in _key_fallback\n    raise exc.NoSuchColumnError(\nsqlalchemy.exc.NoSuchColumnError: Could not locate column in row for column '0'"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/export/csv", "status_code": 500, "duration_ms": 3.43, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:31.264326Z"}
___________________________ test_health_endpoint_ok ____________________________

client = <FlaskClient <MosaicFlask 'app'>>

>   ???
E   AssertionError: assert 500 == 200
E    +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code
E    +    where <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]> = <bound method Client.get of <FlaskClient <MosaicFlask 'app'>>>('/')
E    +      where <bound method Client.get of <FlaskClient <MosaicFlask 'app'>>> = <FlaskClient <MosaicFlask 'app'>>.get

/home/jan/Dokumenty/code/mosaic/backend/tests/test_health.py:19: AssertionError
----------------------------- Captured stdout call -----------------------------
{"status_code": 500, "error": "cannot import name 'home' from 'app' (/app/app.py)", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:31.627754Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/admin_controller.py\", line 13, in home\n    from app import (\nImportError: cannot import name 'home' from 'app' (/app/app.py)"}
{"method": "GET", "path": "/", "status_code": 500, "duration_ms": 0.88, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:31.628614Z"}
------------------------------ Captured log call -------------------------------
ERROR    mosaic.backend:app.py:355 {"status_code": 500, "error": "cannot import name 'home' from 'app' (/app/app.py)", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:31.627754Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/admin_controller.py\", line 13, in home\n    from app import (\nImportError: cannot import name 'home' from 'app' (/app/app.py)"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/", "status_code": 500, "duration_ms": 0.88, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:31.628614Z"}
__________________________ test_add_entry_idempotent ___________________________

client = <FlaskClient <MosaicFlask 'app'>>

>   ???
E   assert 500 == 200
E    +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

/home/jan/Dokumenty/code/mosaic/backend/tests/test_idempotent_writes.py:44: AssertionError
----------------------------- Captured stdout call -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "idempotent_3a568fc9"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:32.743731Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 118.35, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:32.765269Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "idempotent_3a568fc9", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:32.892636Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 147.01, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:32.913679Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 5.14, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:32.919709Z"}
{"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 0.17, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:32.920882Z"}
{"status_code": 500, "error": "'tuple' object has no attribute 'user_id'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:32.921660Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/entries_controller.py\", line 131, in get_today\n    data = stats_service.get_today_payload(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/stats_service.py\", line 29, in get_today_payload\n    cached = cache_get(\"today\", cache_key_parts, scope=cache_scope)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 41, in cache_get\n    key = build_cache_key(prefix, key_parts, scope=scope)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 35, in build_cache_key\n    namespaced_parts = _cache_scope_key_parts(scope) + key_parts\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 26, in _cache_scope_key_parts\n    f\"user:{scope.user_id}\" if scope.user_id is not None else \"user:anonymous\"\n                               ^^^^^^^^^^^^^\nAttributeError: 'tuple' object has no attribute 'user_id'"}
{"method": "GET", "path": "/today", "status_code": 500, "duration_ms": 1.05, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:32.922674Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "idempotent_3a568fc9"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:32.743731Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 118.35, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:32.765269Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "idempotent_3a568fc9", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:32.892636Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 147.01, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:32.913679Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 5.14, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:32.919709Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_entry", "status_code": 201, "duration_ms": 0.17, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:32.920882Z"}
ERROR    mosaic.backend:app.py:355 {"status_code": 500, "error": "'tuple' object has no attribute 'user_id'", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:32.921660Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/entries_controller.py\", line 131, in get_today\n    data = stats_service.get_today_payload(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/services/stats_service.py\", line 29, in get_today_payload\n    cached = cache_get(\"today\", cache_key_parts, scope=cache_scope)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 41, in cache_get\n    key = build_cache_key(prefix, key_parts, scope=scope)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 35, in build_cache_key\n    namespaced_parts = _cache_scope_key_parts(scope) + key_parts\n                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/infra/cache_manager.py\", line 26, in _cache_scope_key_parts\n    f\"user:{scope.user_id}\" if scope.user_id is not None else \"user:anonymous\"\n                               ^^^^^^^^^^^^^\nAttributeError: 'tuple' object has no attribute 'user_id'"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/today", "status_code": 500, "duration_ms": 1.05, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:32.922674Z"}
__________________ test_add_activity_idempotent_and_overwrite __________________

client = <FlaskClient <MosaicFlask 'app'>>

>   ???
E   assert 500 == 200
E    +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

/home/jan/Dokumenty/code/mosaic/backend/tests/test_idempotent_writes.py:83: AssertionError
----------------------------- Captured stdout call -----------------------------
{"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "idempotent_ac9a7cb0"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:33.381561Z"}
{"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 177.39, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:33.404598Z"}
{"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "idempotent_ac9a7cb0", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:33.589197Z"}
{"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 209.48, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:33.615473Z"}
{"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Offline Habit", "category": "Offline"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:33.620616Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 11.35, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:33.627978Z"}
{"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 0.55, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:33.631020Z"}
{"method": "POST", "path": "/add_activity", "status_code": 500, "duration_ms": 1.97, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:33.633961Z"}
------------------------------ Captured log call -------------------------------
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.register", "user_id": 1, "message": "User registered", "context": {"username": "idempotent_ac9a7cb0"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:33.381561Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 201, "duration_ms": 177.39, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:33.404598Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "auth.login", "user_id": 1, "message": "User logged in", "context": {"username": "idempotent_ac9a7cb0", "is_admin": false}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:33.589197Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/login", "status_code": 200, "duration_ms": 209.48, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:33.615473Z"}
INFO     mosaic.audit:audit.py:124 {"event_type": "activity.create", "user_id": 1, "message": "Activity created", "context": {"name": "Offline Habit", "category": "Offline"}, "event": "activity_event", "level": "info", "timestamp": "2025-11-18T18:33:33.620616Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 11.35, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:33.627978Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 201, "duration_ms": 0.55, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:33.631020Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/add_activity", "status_code": 500, "duration_ms": 1.97, "user_id": 1, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:33.633961Z"}
_____________________ test_import_csv_skips_duplicate_rows _____________________

tmp_path = PosixPath('/tmp/pytest-of-root/pytest-0/test_import_csv_skips_duplicat0')

>   ???
E   assert None is not None

/home/jan/Dokumenty/code/mosaic/backend/tests/test_import_validation.py:47: AssertionError
_______________ test_import_csv_updates_existing_and_creates_new _______________

tmp_path = PosixPath('/tmp/pytest-of-root/pytest-0/test_import_csv_updates_existi0')

>   ???
E   assert 5.0  5.0e-06 == 8.0
E     
E     comparison failed
E     Obtained: 8.0
E     Expected: 5.0  5.0e-06

/home/jan/Dokumenty/code/mosaic/backend/tests/test_import_validation.py:128: AssertionError
_______________________ test_metrics_counts_and_latency ________________________

client = <FlaskClient <MosaicFlask 'app'>>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7a2c6bff7ec0>

>   ???
E   AssertionError: assert 500 == 200
E    +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code
E    +    where <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]> = <bound method Client.get of <FlaskClient <MosaicFlask 'app'>>>('/')
E    +      where <bound method Client.get of <FlaskClient <MosaicFlask 'app'>>> = <FlaskClient <MosaicFlask 'app'>>.get

/home/jan/Dokumenty/code/mosaic/backend/tests/test_metrics.py:33: AssertionError
----------------------------- Captured stdout call -----------------------------
{"status_code": 500, "error": "cannot import name 'home' from 'app' (/app/app.py)", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:34.961822Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/admin_controller.py\", line 13, in home\n    from app import (\nImportError: cannot import name 'home' from 'app' (/app/app.py)"}
{"method": "GET", "path": "/", "status_code": 500, "duration_ms": 50.0, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:34.962560Z"}
------------------------------ Captured log call -------------------------------
ERROR    mosaic.backend:app.py:355 {"status_code": 500, "error": "cannot import name 'home' from 'app' (/app/app.py)", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:34.961822Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/app/controllers/admin_controller.py\", line 13, in home\n    from app import (\nImportError: cannot import name 'home' from 'app' (/app/app.py)"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/", "status_code": 500, "duration_ms": 50.0, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:34.962560Z"}
_________________________ test_metrics_error_counters __________________________

client = <FlaskClient <MosaicFlask 'app'>>

>   ???

/home/jan/Dokumenty/code/mosaic/backend/tests/test_metrics.py:58: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

snapshot = {'avg_latency_ms': 0.63, 'endpoints': [{'avg_latency_ms': 0.47, 'count': 1, 'endpoint': 'auth.register', 'errors_4xx':... 'errors_4xx': 0, ...}], 'errors_total': {'4xx': 1, '5xx': 1}, 'last_updated': '2025-11-18T18:33:35.223245+00:00', ...}
endpoint = 'register'

>   ???
E   StopIteration

/home/jan/Dokumenty/code/mosaic/backend/tests/test_metrics.py:19: StopIteration
----------------------------- Captured stdout call -----------------------------
{"status_code": 400, "error_code": "invalid_input", "details": {"fields": ["username", "password"]}, "message": "Missing required field(s): username, password", "event": "request.validation_error", "level": "warning", "timestamp": "2025-11-18T18:33:35.221635Z"}
{"method": "POST", "path": "/register", "status_code": 400, "duration_ms": 0.47, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:35.221982Z"}
{"status_code": 500, "error": "boom", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:35.222482Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/jan/Dokumenty/code/mosaic/backend/tests/test_metrics.py\", line 12, in metrics_test_boom\nRuntimeError: boom"}
{"method": "GET", "path": "/__metrics_test__/boom", "status_code": 500, "duration_ms": 0.79, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:35.223278Z"}
------------------------------ Captured log call -------------------------------
WARNING  mosaic.backend:app.py:328 {"status_code": 400, "error_code": "invalid_input", "details": {"fields": ["username", "password"]}, "message": "Missing required field(s): username, password", "event": "request.validation_error", "level": "warning", "timestamp": "2025-11-18T18:33:35.221635Z"}
INFO     mosaic.backend:app.py:304 {"method": "POST", "path": "/register", "status_code": 400, "duration_ms": 0.47, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:35.221982Z"}
ERROR    mosaic.backend:app.py:355 {"status_code": 500, "error": "boom", "event": "request.unhandled_exception", "level": "error", "timestamp": "2025-11-18T18:33:35.222482Z", "exception": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 880, in full_dispatch_request\n    rv = self.dispatch_request()\n         ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/site-packages/flask/app.py\", line 865, in dispatch_request\n    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/jan/Dokumenty/code/mosaic/backend/tests/test_metrics.py\", line 12, in metrics_test_boom\nRuntimeError: boom"}
INFO     mosaic.backend:app.py:304 {"method": "GET", "path": "/__metrics_test__/boom", "status_code": 500, "duration_ms": 0.79, "user_id": null, "event": "request.completed", "level": "info", "timestamp": "2025-11-18T18:33:35.223278Z"}
_______________________ test_get_today_entries_and_goals _______________________

self = <sqlalchemy.engine.base.Connection object at 0x7a2c6bfc8410>
dialect = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7a2c71af8a10>
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7a2c6bfc8320>
statement = <sqlalchemy.dialects.postgresql.base.PGCompiler object at 0x7a2c71889670>
parameters = [{'active': True, 'activity_type': 'positive', 'category': 'Health', 'deactivated_at': None, ...}]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7a2c71af8a10>
cursor = <cursor object at 0x7a2c70213a60; closed: -1>
statement = 'INSERT INTO activities (name, category, activity_type, goal, description, active, frequency_per_day, frequency_per_we...s, %(active)s, %(frequency_per_day)s, %(frequency_per_week)s, %(deactivated_at)s, %(user_id)s) RETURNING activities.id'
parameters = {'active': True, 'activity_type': 'positive', 'category': 'Health', 'deactivated_at': None, ...}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7a2c6bfc8320>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       psycopg2.errors.ForeignKeyViolation: insert or update on table "activities" violates foreign key constraint "activities_user_id_fkey"
E       DETAIL:  Key (user_id)=(1) is not present in table "users".

/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: ForeignKeyViolation

The above exception was the direct cause of the following exception:

>   ???

/home/jan/Dokumenty/code/mosaic/backend/tests/test_stats_repo.py:36: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/scoping.py:597: in commit
    return self._proxied.commit()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2030: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1311: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1286: in _prepare_impl
    self.session.flush()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7a2c71af8a10>
cursor = <cursor object at 0x7a2c70213a60; closed: -1>
statement = 'INSERT INTO activities (name, category, activity_type, goal, description, active, frequency_per_day, frequency_per_we...s, %(active)s, %(frequency_per_day)s, %(frequency_per_week)s, %(deactivated_at)s, %(user_id)s) RETURNING activities.id'
parameters = {'active': True, 'activity_type': 'positive', 'category': 'Health', 'deactivated_at': None, ...}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7a2c6bfc8320>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.IntegrityError: (psycopg2.errors.ForeignKeyViolation) insert or update on table "activities" violates foreign key constraint "activities_user_id_fkey"
E       DETAIL:  Key (user_id)=(1) is not present in table "users".
E       
E       [SQL: INSERT INTO activities (name, category, activity_type, goal, description, active, frequency_per_day, frequency_per_week, deactivated_at, user_id) VALUES (%(name)s, %(category)s, %(activity_type)s, %(goal)s, %(description)s, %(active)s, %(frequency_per_day)s, %(frequency_per_week)s, %(deactivated_at)s, %(user_id)s) RETURNING activities.id]
E       [parameters: {'name': 'Run', 'category': 'Health', 'activity_type': 'positive', 'goal': 5.0, 'description': 'Morning run', 'active': True, 'frequency_per_day': 1, 'frequency_per_week': 7, 'deactivated_at': None, 'user_id': 1}]
E       (Background on this error at: https://sqlalche.me/e/20/gkpj)

/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: IntegrityError
__________________________ test_daily_positive_totals __________________________

self = <sqlalchemy.engine.base.Connection object at 0x7a2c703ab410>
dialect = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7a2c71af8a10>
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7a2c703955e0>

    def _exec_insertmany_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for an "insertmanyvalues"
        operation, which will invoke DBAPI
        cursor.execute() one or more times with individual log and
        event hook calls.
    
        """
    
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
        else:
            generic_setinputsizes = None
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters = parameters
    
        engine_events = self._has_events or self.engine._has_events
        if self.dialect._has_events:
            do_execute_dispatch: Iterable[Any] = (
                self.dialect.dispatch.do_execute
            )
        else:
            do_execute_dispatch = ()
    
        if self._echo:
            stats = context._get_cache_stats() + " (insertmanyvalues)"
    
        preserve_rowcount = context.execution_options.get(
            "preserve_rowcount", False
        )
        rowcount = 0
    
        for imv_batch in dialect._deliver_insertmanyvalues_batches(
            self,
            cursor,
            str_statement,
            effective_parameters,
            generic_setinputsizes,
            context,
        ):
            if imv_batch.processed_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor,
                        imv_batch.processed_setinputsizes,
                        context,
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e,
                        sql_util._long_statement(imv_batch.replaced_statement),
                        imv_batch.replaced_parameters,
                        None,
                        context,
                        is_sub_exec=True,
                    )
    
            sub_stmt = imv_batch.replaced_statement
            sub_params = imv_batch.replaced_parameters
    
            if engine_events:
                for fn in self.dispatch.before_cursor_execute:
                    sub_stmt, sub_params = fn(
                        self,
                        cursor,
                        sub_stmt,
                        sub_params,
                        context,
                        True,
                    )
    
            if self._echo:
                self._log_info(sql_util._long_statement(sub_stmt))
    
                imv_stats = f""" {imv_batch.batchnum}/{
                            imv_batch.total_batches
                } ({
                    'ordered'
                    if imv_batch.rows_sorted else 'unordered'
                }{
                    '; batch not supported'
                    if imv_batch.is_downgraded
                    else ''
                })"""
    
                if imv_batch.batchnum == 1:
                    stats += imv_stats
                else:
                    stats = f"insertmanyvalues{imv_stats}"
    
                if not self.engine.hide_parameters:
                    self._log_info(
                        "[%s] %r",
                        stats,
                        sql_util._repr_params(
                            sub_params,
                            batches=10,
                            ismulti=False,
                        ),
                    )
                else:
                    self._log_info(
                        "[%s] [SQL parameters hidden due to "
                        "hide_parameters=True]",
                        stats,
                    )
    
            try:
                for fn in do_execute_dispatch:
                    if fn(
                        cursor,
                        sub_stmt,
                        sub_params,
                        context,
                    ):
                        break
                else:
>                   dialect.do_execute(
                        cursor,
                        sub_stmt,
                        sub_params,
                        context,
                    )

/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2118: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7a2c71af8a10>
cursor = <cursor object at 0x7a2c702395d0; closed: -1>
statement = 'INSERT INTO entries (date, activity, description, value, note, activity_category, activity_goal, activity_type, user_...mp_sen(p0, p1, p2, p3, p4, p5, p6, p7, p8, sen_counter) ORDER BY sen_counter RETURNING entries.id, entries.id AS id__1'
parameters = {'activity__0': 'Yoga', 'activity__1': 'Yoga', 'activity_category__0': 'Wellness', 'activity_category__1': 'Wellness', ...}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7a2c703955e0>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       psycopg2.errors.ForeignKeyViolation: insert or update on table "entries" violates foreign key constraint "entries_user_id_fkey"
E       DETAIL:  Key (user_id)=(2) is not present in table "users".

/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: ForeignKeyViolation

The above exception was the direct cause of the following exception:

>   ???

/home/jan/Dokumenty/code/mosaic/backend/tests/test_stats_repo.py:75: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/scoping.py:597: in commit
    return self._proxied.commit()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2030: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1311: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1286: in _prepare_impl
    self.session.flush()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4331: in flush
    self._flush(objects)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4466: in _flush
    with util.safe_reraise():
/usr/local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4427: in _flush
    flush_context.execute()
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
/usr/local/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1143: in _emit_insert_statements
    result = connection.execute(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/usr/local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1844: in _execute_context
    return self._exec_insertmany_context(dialect, context)
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2126: in _exec_insertmany_context
    self._handle_dbapi_exception(
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2118: in _exec_insertmany_context
    dialect.do_execute(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x7a2c71af8a10>
cursor = <cursor object at 0x7a2c702395d0; closed: -1>
statement = 'INSERT INTO entries (date, activity, description, value, note, activity_category, activity_goal, activity_type, user_...mp_sen(p0, p1, p2, p3, p4, p5, p6, p7, p8, sen_counter) ORDER BY sen_counter RETURNING entries.id, entries.id AS id__1'
parameters = {'activity__0': 'Yoga', 'activity__1': 'Yoga', 'activity_category__0': 'Wellness', 'activity_category__1': 'Wellness', ...}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x7a2c703955e0>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.IntegrityError: (psycopg2.errors.ForeignKeyViolation) insert or update on table "entries" violates foreign key constraint "entries_user_id_fkey"
E       DETAIL:  Key (user_id)=(2) is not present in table "users".
E       
E       [SQL: INSERT INTO entries (date, activity, description, value, note, activity_category, activity_goal, activity_type, user_id) SELECT p0::VARCHAR, p1::VARCHAR, p2::TEXT, p3::FLOAT, p4::TEXT, p5::VARCHAR, p6::FLOAT, p7::VARCHAR, p8::INTEGER FROM (VALUES (%( ... 355 characters truncated ...  p3, p4, p5, p6, p7, p8, sen_counter) ORDER BY sen_counter RETURNING entries.id, entries.id AS id__1]
E       [parameters: {'date__0': '2024-04-01', 'activity_type__0': 'positive', 'activity_goal__0': 2.0, 'note__0': '', 'user_id__0': 2, 'activity__0': 'Yoga', 'activity_category__0': 'Wellness', 'value__0': 2.0, 'description__0': '', 'date__1': '2024-04-02', 'activity_type__1': 'positive', 'activity_goal__1': 2.0, 'note__1': '', 'user_id__1': 2, 'activity__1': 'Yoga', 'activity_category__1': 'Wellness', 'value__1': 1.0, 'description__1': ''}]
E       (Background on this error at: https://sqlalche.me/e/20/gkpj)

/usr/local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: IntegrityError
____________________ test_import_csv_rolls_back_on_failure _____________________

tmp_path = PosixPath('/tmp/pytest-of-root/pytest-0/test_import_csv_rolls_back_on_0')
client = <FlaskClient <MosaicFlask 'app'>>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7a2c703b3560>

>   ???
E   Failed: DID NOT RAISE <class 'RuntimeError'>

/home/jan/Dokumenty/code/mosaic/backend/tests/test_transactions.py:30: Failed
_____________________________ test_users_repo_crud _____________________________

>   ???
E   assert None is not None

/home/jan/Dokumenty/code/mosaic/backend/tests/test_users_repo.py:19: AssertionError
=============================== warnings summary ===============================
tests/test_activities_repo.py::test_insert_activity_and_overwrite
tests/test_activities_repo.py::test_update_activity_propagates_entries
tests/test_activities_repo.py::test_activate_deactivate_and_delete
  /app/tests/test_activities_repo.py:12: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    user = User(username=username, password_hash="hash", created_at=datetime.utcnow())

tests/test_entries_repo.py::test_upsert_creates_and_updates_entry
tests/test_entries_repo.py::test_upsert_adopts_shared_entry
tests/test_entries_repo.py::test_create_missing_entries_for_day
  /app/tests/test_entries_repo.py:12: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    user = User(username=username, password_hash="hash", created_at=datetime.utcnow())

tests/test_users_repo.py::test_users_repo_crud
  /home/jan/Dokumenty/code/mosaic/backend/tests/test_users_repo.py:12: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).

tests/test_users_repo.py::test_users_repo_crud
  /home/jan/Dokumenty/code/mosaic/backend/tests/test_users_repo.py:14: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).

tests/test_wearable_repo.py::test_ingest_wearable_batch_creates_source_and_raw
  /app/tests/test_wearable_repo.py:12: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    user = User(username=username, password_hash="hash", created_at=datetime.utcnow())

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_activities_repo.py::test_insert_activity_and_overwrite - sq...
FAILED tests/test_api.py::test_add_activity_and_toggle - AssertionError: asse...
FAILED tests/test_api.py::test_add_entry_upsert - assert 201 == 200
FAILED tests/test_api.py::test_today_and_finalize_day - AssertionError: asser...
FAILED tests/test_api.py::test_update_activity_propagates - AssertionError: a...
FAILED tests/test_api.py::test_today_respects_deactivation_date - TypeError: ...
FAILED tests/test_api.py::test_entry_metadata_survives_activity_deletion - St...
FAILED tests/test_api.py::test_entries_filtering - assert 0 == 1
FAILED tests/test_api.py::test_stats_progress_payload_structure - assert 500 ...
FAILED tests/test_api.py::test_entries_pagination - assert 0 == 2
FAILED tests/test_api.py::test_today_pagination - assert 500 == 200
FAILED tests/test_api.py::test_today_cache_invalidation - assert 500 == 200
FAILED tests/test_api.py::test_stats_cache_invalidation - assert 500 == 200
FAILED tests/test_api.py::test_negative_activity_entries_and_today - assert []
FAILED tests/test_api.py::test_negative_activity_ignored_in_stats - assert 50...
FAILED tests/test_backup_manager.py::test_backup_run_creates_files - assert N...
FAILED tests/test_backup_manager.py::test_backup_toggle_persistence - assert ...
FAILED tests/test_cache_namespace.py::test_cache_entries_are_namespaced_per_user
FAILED tests/test_entries_repo.py::test_upsert_creates_and_updates_entry - as...
FAILED tests/test_entries_repo.py::test_upsert_adopts_shared_entry - assert N...
FAILED tests/test_export.py::test_export_json_includes_entries_and_activities
FAILED tests/test_export.py::test_export_pagination_offset - assert 500 == 200
FAILED tests/test_export.py::test_export_csv_format - assert 500 == 200
FAILED tests/test_health.py::test_health_endpoint_ok - AssertionError: assert...
FAILED tests/test_idempotent_writes.py::test_add_entry_idempotent - assert 50...
FAILED tests/test_idempotent_writes.py::test_add_activity_idempotent_and_overwrite
FAILED tests/test_import_validation.py::test_import_csv_skips_duplicate_rows
FAILED tests/test_import_validation.py::test_import_csv_updates_existing_and_creates_new
FAILED tests/test_metrics.py::test_metrics_counts_and_latency - AssertionErro...
FAILED tests/test_metrics.py::test_metrics_error_counters - StopIteration
FAILED tests/test_stats_repo.py::test_get_today_entries_and_goals - sqlalchem...
FAILED tests/test_stats_repo.py::test_daily_positive_totals - sqlalchemy.exc....
FAILED tests/test_transactions.py::test_import_csv_rolls_back_on_failure - Fa...
FAILED tests/test_users_repo.py::test_users_repo_crud - assert None is not None
================== 34 failed, 49 passed, 9 warnings in 36.21s ==================
